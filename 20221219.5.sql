/*
무결성 제약 조건

  무결성 : 데이터베이스 내에 데이터의 확장성을 유지하는 것을 의미한다.
          바람직하지 않은 데이터가 저장되는 것을 방지하는 것을 말함
        
        
        NOT NULL        : NULL을 허용하지 않는다
        UNIQUE          : 중복된 값을 허용하지 않는다
        PRIMARY KEY     : NOT NULL + UNIQUE (기본키)
        FOREIGN KEY     : 참조되는 테이블의 컬럼의 값이 존재하면 허용함 (외래키)
        CHECK           : 저장 가능한 데이터 값의 범위나 조건을 지정하여 설정한 값만을 허용
*/

select * from emp01;
drop table emp01;


create table EMP01(
EMPNO NUMBER(4),
ENAME VARCHAR2(10),
JOB VARCHAR2(9),
DEPTNO NUMBER(4)
);

INSERT INTO EMP01 VALUES(NULL,NULL,'SALESMAN',30);
SELECT * FROM EMP01;

-- 사원번호, 사원명, 직급, 부서번호로 구성하되, 사원번호와 사원명에 NOT NULL 조건을 지정
CREATE TABLE EMP02(
EMPNO NUMBER(4) NOT NULL,
ENAME VARCHAR2(10) NOT NULL,
JOB VARCHAR2(9),
DEPTNO NUMBER(4)
);

INSERT INTO EMP02 VALUES(7499, 'ALLEN', 'SALESMAN', 30);
INSERT INTO EMP02 VALUES(7499, 'PKNAME', 'MANAGER', 20);
SELECT * FROM EMP02;
DROP TABLE EMP02;



CREATE TABLE EMP03(
EMPNO NUMBER(4) UNIQUE,
ENAME VARCHAR2(10) NOT NULL,
JOB VARCHAR2(9),
DEPTNO NUMBER(4)
);

INSERT INTO EMP03 VALUES(7499, 'ALLEN', 'SALESMAN', 30);
INSERT INTO EMP03 VALUES(7499, 'PKNAME', 'MANAGER', 20);
INSERT INTO EMP03 VALUES(NULL, 'JONES', 'MANAGER', 20);
DROP TABLE EMP03;

PURGE RECYCLEBIN;


CREATE TABLE EMP04(
EMPNO NUMBER(4) PRIMARY KEY,
ENAME VARCHAR2(10) NOT NULL,
JOB VARCHAR2(9),
DEPTNO NUMBER(4)
);

drop table emp04;
INSERT INTO EMP04 VALUES(7499, 'ALLEN', 'SALESMAN', 30);
INSERT INTO EMP04 VALUES(7499, 'PKNAME', 'MANAGER', 20);
INSERT INTO EMP04 VALUES(NULL, 'JONES', 'MANAGER', 20);


SELECT CONSTRAINT_NAME, CONSTRAINT_TYPE, TABLE_NAME FROM USER_CONSTRAINTS WHERE TABLE_NAME='EMP04';
--       제약 조건명      제약 조건유형  제약조건이 속한 테이블명
/*
  CONTRAINT_TYPE
    - P     : PRIMARY KEY
    - R     : FOREIGN KEY 
    - U     : UNIQUE KEY
    - C     : CHECK NOT NULL  (NOT NULL 을 유무 확인) 
*/


SELECT * FROM USER_CONS_COLUMNS WHERE TABLE_NAME='EMP04';
SELECT * FROM EMP04;

/*
  참조 무결성을 위한 FOREIGN KEY 제약 조건
    참조 무결성은 두 테이블 상이의 주종 관계에서 설정된다.
    
    먼저 존재해야하는 테이블(주 : 부모테이블)
    이를 참조하는 테이블(종 : 자식테이블)
    
        부서         소속         사원

*/

SELECT CONSTRAINT_NAME, CONSTRAINT_TYPE, TABLE_NAME FROM USER_CONSTRAINTS WHERE TABLE_NAME='DEPT';
DESC DEPT;
SELECT * FROM USER_CONS_COLUMNS WHERE TABLE_NAME='DEPT';

CREATE TABLE DEPT01(
DEPTNO NUMBER(2) PRIMARY KEY,
DNAME VARCHAR2(14),
LOC VARCHAR2(13)
);
SELECT * FROM USER_CONS_COLUMNS WHERE TABLE_NAME='DEPT01';
SELECT * FROM DEPT;
INSERT INTO DEPT01 VALUES(10, 'ACCOUNTING', 'NEW YORK');
INSERT INTO DEPT01 VALUES(20, 'RESEARCH', 'DALLAS');
INSERT INTO DEPT01 VALUES(30, 'SALES', 'CHICAGO');
INSERT INTO DEPT01 VALUES(40, 'OPERATIONS', 'BOSTON');


CREATE TABLE EMP05(
EMPNO NUMBER(4) PRIMARY KEY,
ENAME VARCHAR2(10) NOT NULL,
JOB VARCHAR2(9),
DEPTNO NUMBER(2) REFERENCES DEPT01(DEPTNO)
);
drop table emp05;

DROP TABLE DEPT01;

SELECT * FROM EMP05;
INSERT INTO EMP05 VALUES(7499, 'ALLEN', 'SALESMAN', 30);
INSERT INTO EMP05 VALUES(7566, 'JONES', 'MANAGER', 50);
SELECT * FROM EMP01;
SELECT CONSTRAINT_NAME, CONSTRAINT_TYPE, TABLE_NAME FROM USER_CONSTRAINTS WHERE TABLE_NAME='EMP05';
SELECT * FROM USER_CONS_COLUMNS WHERE TABLE_NAME='EMP05';



/*
  CHECK 제약 조건 
    - 입력된 값을 체크하여 설정된 값 이외의 값이 들어오면 오류메시지와 함께 명령이 수행되지 못하게 하는 것을 의미함
*/
-- EMP06 사원 테일블에 GENDER(성별)컬럼을 추가하되 GENDER컬럼에는 'M', 'F'의 두 값만 저장할 수 있는 CHECK 제약 조건 설정
CREATE TABLE EMP06(
EMPNO NUMBER(4) PRIMARY KEY,
ENAME VARCHAR2(10) NOT NULL,
GENDER VARCHAR2(1) CHECK(GENDER IN('M', 'F'))
);
drop table emp06;

INSERT INTO EMP06 VALUES(7566, 'JONES', 'M');
SELECT * FROM EMP06;
SELECT CONSTRAINT_NAME, CONSTRAINT_TYPE, TABLE_NAME FROM USER_CONSTRAINTS WHERE TABLE_NAME='EMP06';
SELECT * FROM USER_CONS_COLUMNS WHERE TABLE_NAME='EMP06';

/*
  제약 조건명 지정하기
    - 사용자가 의미있게 제약 조건명을 명시하여 제약 조건명만으로도 어떤 제약조건을 위배했는지
      알 수 있게 지정하는 방법
      
  제약 조건 명시법
    - 컬럼명, 데이터 타입, 제약조건, 제약조건이름, 제약조건타입
    
    - 제약 조건명 규칙
      테이블명_컬럼명_제약조건유형
    
    - EMP06_EMPNO_PK
      테이블명 컬럼명 제약조건유형
*/

CREATE TABLE EMP07(
EMPNO NUMBER(4) CONSTRAINT EMP07_EMPNO_PK PRIMARY KEY,
ENAME VARCHAR2(10) CONSTRAINT EMP07_EMPNAME_NN NOT NULL,
JOB VARCHAR2(9) CONSTRAINT EMP07_JOB_UK UNIQUE,
DEPTNO NUMBER(2) CONSTRAINT EMP07_DEPTNO_FK REFERENCES DEPT01(DEPTNO)
);

SELECT * FROM EMP07;
INSERT INTO EMP07 VALUES(7499, 'ALLEN', 'SALESMAN', 30);
INSERT INTO EMP07 VALUES(7450, 'ALLEN', 'MANAGER', 50);

SELECT CONSTRAINT_NAME, CONSTRAINT_TYPE, TABLE_NAME, R_CONSTRAINT_NAME FROM USER_CONSTRAINTS WHERE TABLE_NAME='EMP07';

SELECT * FROM USER_CONS_COLUMNS WHERE TABLE_NAME='EMP07';

INSERT INTO EMP07 VALUES(7499, 'ALLEN', 'SALESMAN', 30);
INSERT INTO EMP07 VALUES(7499, NULL, 'SALESMAN', 30);

INSERT INTO EMP07 VALUES(7491, 'ALLEN', 'SALESMAN', 50);

SELECT * FROM EMP07;


DROP TABLE EMP07;
CREATE TABLE EMP07(
EMPNO NUMBER(4),
ENAME VARCHAR2(10),
JOB VARCHAR2(9),
DEPTNO NUMBER(2),
CONSTRAINT EMP07_EMPNO_PK PRIMARY KEY(EMPNO),
CONSTRAINT EMP07_JOB_UK UNIQUE(JOB),
CONSTRAINT EMP07_DEPTNO_FK FOREIGN KEY(DEPTNO) REFERENCES DEPT01(DEPTNO)
);

/*
CONSTRAINT EMP07_EMPNO_PK PRIMARY KEY
CONSTRAINT EMP07_ENAME_NN NOT NULL
CONSTRAINT EMP07_JOB_UK UNIQUE
CONSTRAINT EMP07_DEPTNO_FK REFERENCES DEPT01(DEPTNO)

PRIMARY KEY(EMPNO),
UNIQUE(ENAME),
UNIQUE(JOB),
FOREIGN KEY(DEPTNO) REFERENCES DEPT01(DEPTNO)
*/

SELECT CONSTRAINT_NAME, CONSTRAINT_TYPE, TABLE_NAME, R_CONSTRAINT_NAME FROM USER_CONSTRAINTS WHERE TABLE_NAME='EMP07';
SELECT * FROM USER_CONS_COLUMNS WHERE TABLE_NAME='EMP07';

SELECT * FROM EMP01;
DELETE FROM EMP01;
SELECT CONSTRAINT_NAME, CONSTRAINT_TYPE, TABLE_NAME, R_CONSTRAINT_NAME FROM USER_CONSTRAINTS WHERE TABLE_NAME='EMP01';
/*
  제약 조건 변경하기
    - 테이블 생성이 끝난 후에 제약조건을 추가하기 위해서는 ALTER TABLE로 추가하면 됨
    
      ALTER TABLE 테이블명
      ADD 제약조건 제약조건명 제약조건유형(컬럼이름)
*/

SELECT * FROM TAB;
-- EMP01, DEPT01 
-- EMP01 테이블의 EMPNO컬럼의 기본키를 설정하고 DEPTNO컬럼에 외래키 설정
ALTER TABLE EMP01
ADD PRIMARY KEY(EMPNO);

ALTER TABLE EMP01
ADD CONSTRAINT EMP01_DEPTNO_FK FOREIGN KEY(DEPTNO) REFERENCES DEPT01(DEPTNO); 

-- 제약조건 제거
ALTER TABLE EMP01
DROP CONSTRAINT EMP01_DEPTNO_FK 

/*
  제약조건의 비활성화와 CASCADE
  DISABLE CONSTRAINT : 제약 조건을 일시적으로 비활성화
  ENABLE CONSTRAINT  : 비활성화된 제약조건을 활성화
*/

DROP TABLE EMP01;

DROP TABLE DEPT01;

create table EMP01(
EMPNO NUMBER(4),
ENAME VARCHAR2(10) CONSTRAINT EMP01_ENAME_NN NOT NULL,
JOB VARCHAR2(9),
DEPTNO NUMBER(4),
CONSTRAINT EMP01_EMPNO_PK PRIMARY KEY(EMPNO),
CONSTRAINT EMP01_DEPTNO_FK FOREIGN KEY(DEPTNO) REFERENCES DEPT01(DEPTNO)
);

INSERT INTO EMP01 VALUES(7499, 'ALLEN', 'SALESMAN', 10);
INSERT INTO EMP01 VALUES(7369, 'SMITH', 'CLERK', 20);
SELECT * FROM EMP01;

SELECT CONSTRAINT_NAME, CONSTRAINT_TYPE, TABLE_NAME, R_CONSTRAINT_NAME, STATUS FROM USER_CONSTRAINTS WHERE TABLE_NAME='EMP01';

DELETE FROM DEPT01 WHERE DEPTNO=10;
ROLLBACK;

ALTER TABLE EMP01
DISABLE CONSTRAINT EMP01_DEPTNO_FK;

ALTER TABLE EMP01
ENABLE CONSTRAINT EMP01_DEPTNO_FK;

SELECT * FROM DEPT01;
ROLLBACK;